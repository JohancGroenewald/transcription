#!/usr/bin/env sh

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
SCRIPT="$REPO_ROOT/.githooks/bump-version.ps1"
CLOSE_SCRIPT="$REPO_ROOT/.githooks/close-voicetype.ps1"
PROJECT="$REPO_ROOT/VoiceType/VoiceType.csproj"
if [ -f "$CLOSE_SCRIPT" ]; then
  if command -v pwsh >/dev/null 2>&1; then
    if ! pwsh -NoProfile -ExecutionPolicy Bypass -File "$CLOSE_SCRIPT" -MaxWaitMilliseconds 10000; then
      echo "[pre-commit] close-voicetype did not finish in time."
      exit 1
    fi
  elif command -v powershell >/dev/null 2>&1; then
    if ! powershell -NoProfile -ExecutionPolicy Bypass -File "$CLOSE_SCRIPT" -MaxWaitMilliseconds 10000; then
      echo "[pre-commit] close-voicetype did not finish in time."
      exit 1
    fi
  fi
fi

if command -v dotnet >/dev/null 2>&1 && [ -f "$PROJECT" ]; then
  if ! dotnet build "$PROJECT" -c Debug; then
    echo "[pre-commit] Build failed. Please fix compilation errors before committing."
    exit 1
  fi
elif [ -f "$PROJECT" ]; then
  echo "[pre-commit] dotnet CLI not found. Install .NET SDK to run compile gate."
  exit 1
fi

if [ "${SKIP_VERSION_BUMP:-}" = "1" ]; then
  exit 0
fi

if [ -f "$SCRIPT" ]; then
  if command -v pwsh >/dev/null 2>&1; then
    pwsh -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT"
  elif command -v powershell >/dev/null 2>&1; then
    powershell -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT"
  fi
fi

exit 0
