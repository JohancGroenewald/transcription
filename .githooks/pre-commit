#!/usr/bin/env sh

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
SCRIPT="$REPO_ROOT/.githooks/bump-version.ps1"
CLOSE_SCRIPT="$REPO_ROOT/.githooks/close-voicetype.ps1"
PROJECT="$REPO_ROOT/VoiceType/VoiceType.csproj"

has_app_file_changes() {
  [ ! -d "$REPO_ROOT/.git" ] && return 1
  git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -qE '^VoiceType/'
}

has_markdown_file_changes() {
  [ ! -d "$REPO_ROOT/.git" ] && return 1
  git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -qiE '\.md$'
}

has_json_file_changes() {
  [ ! -d "$REPO_ROOT/.git" ] && return 1
  git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -qiE '\.json$'
}

has_yaml_file_changes() {
  [ ! -d "$REPO_ROOT/.git" ] && return 1
  git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -qiE '\.(ya?ml)$'
}

run_markdown_lint() {
  local markdown_files
  markdown_files="$(git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -iE '\.md$' || true)"
  if [ -z "$markdown_files" ]; then
    return 0
  fi

  local lint_cmd=""
  if command -v markdownlint >/dev/null 2>&1; then
    lint_cmd="markdownlint"
  elif command -v npx >/dev/null 2>&1; then
    lint_cmd="npx -y markdownlint-cli"
  else
    echo "[pre-commit] markdownlint not found (nor npx available). Install markdownlint or Node.js to lint markdown on pre-commit."
    return 1
  fi

  echo "[pre-commit] Running markdown lint on staged markdown files."
  local exit_code=0
  while IFS= read -r md_file; do
    [ -z "$md_file" ] && continue
    if ! $lint_cmd "$md_file"; then
      echo "[pre-commit] Markdown lint failed for: $md_file"
      exit_code=1
    fi
  done <<< "$markdown_files"

  if [ "$exit_code" -ne 0 ]; then
    return 1
  fi
}

run_json_lint() {
  local json_files
  json_files="$(git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -iE '\.json$' || true)"
  if [ -z "$json_files" ]; then
    return 0
  fi

  if ! command -v python >/dev/null 2>&1; then
    echo "[pre-commit] python not found. Install Python to validate staged JSON files."
    return 1
  fi

  echo "[pre-commit] Running JSON lint on staged json files."
  local exit_code=0
  while IFS= read -r json_file; do
    [ -z "$json_file" ] && continue
    if ! python -m json.tool "$json_file" >/dev/null; then
      echo "[pre-commit] JSON lint failed for: $json_file"
      exit_code=1
    fi
  done <<< "$json_files"

  return "$exit_code"
}

run_yaml_lint() {
  local yaml_files
  yaml_files="$(git -C "$REPO_ROOT" diff --cached --name-only --diff-filter=ACMRD -- | grep -iE '\.(ya?ml)$' || true)"
  if [ -z "$yaml_files" ]; then
    return 0
  fi

  echo "[pre-commit] Running YAML lint on staged YAML files."

  if command -v yamllint >/dev/null 2>&1; then
    while IFS= read -r yaml_file; do
      [ -z "$yaml_file" ] && continue
      if ! yamllint "$yaml_file"; then
        echo "[pre-commit] YAML lint failed for: $yaml_file"
        return 1
      fi
    done <<< "$yaml_files"
    return 0
  fi

  if ! command -v python >/dev/null 2>&1; then
    echo "[pre-commit] yamllint not found and python not available. Install yamllint or Python to validate staged YAML files."
    return 1
  fi

  if ! python -c "import yaml" ; then
    echo "[pre-commit] Python YAML parser not available (PyYAML missing). Install yamllint or run: pip install pyyaml"
    return 1
  fi

  while IFS= read -r yaml_file; do
    [ -z "$yaml_file" ] && continue
    if ! python -c "import sys, yaml; yaml.safe_load(open(sys.argv[1], encoding='utf-8'))" "$yaml_file"; then
      echo "[pre-commit] YAML lint failed for: $yaml_file"
      return 1
    fi
  done <<< "$yaml_files"

  return 0
}

if [ "${SKIP_VERSION_BUMP:-}" = "1" ]; then
  exit 0
fi

HAS_APP_CHANGES=$(has_app_file_changes; echo $?)
HAS_MARKDOWN_CHANGES=$(has_markdown_file_changes; echo $?)
HAS_JSON_CHANGES=$(has_json_file_changes; echo $?)
HAS_YAML_CHANGES=$(has_yaml_file_changes; echo $?)

if [ "$HAS_MARKDOWN_CHANGES" -eq 0 ]; then
  if ! run_markdown_lint; then
    echo "[pre-commit] Markdown lint failed. Please fix markdown issues before committing."
    exit 1
  fi
else
  echo "[pre-commit] No staged markdown files to lint."
fi

if [ "$HAS_JSON_CHANGES" -eq 0 ]; then
  if ! run_json_lint; then
    echo "[pre-commit] JSON lint failed. Please fix JSON issues before committing."
    exit 1
  fi
else
  echo "[pre-commit] No staged JSON files to lint."
fi

if [ "$HAS_YAML_CHANGES" -eq 0 ]; then
  if ! run_yaml_lint; then
    echo "[pre-commit] YAML lint failed. Please fix YAML issues before committing."
    exit 1
  fi
else
  echo "[pre-commit] No staged YAML files to lint."
fi

if [ "$HAS_APP_CHANGES" -eq 0 ]; then
  if [ -f "$SCRIPT" ]; then
    if command -v pwsh >/dev/null 2>&1; then
      pwsh -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT"
    elif command -v powershell >/dev/null 2>&1; then
      powershell -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT"
    fi
  fi

  if [ -f "$CLOSE_SCRIPT" ]; then
    if command -v pwsh >/dev/null 2>&1; then
      if ! pwsh -NoProfile -ExecutionPolicy Bypass -File "$CLOSE_SCRIPT" -MaxWaitMilliseconds 10000; then
        echo "[pre-commit] close-voicetype did not finish in time."
        exit 1
      fi
    elif command -v powershell >/dev/null 2>&1; then
      if ! powershell -NoProfile -ExecutionPolicy Bypass -File "$CLOSE_SCRIPT" -MaxWaitMilliseconds 10000; then
        echo "[pre-commit] close-voicetype did not finish in time."
        exit 1
      fi
    fi
  fi

  if command -v dotnet >/dev/null 2>&1 && [ -f "$PROJECT" ]; then
    if ! dotnet build "$PROJECT" -c Debug; then
      echo "[pre-commit] Build failed. Please fix compilation errors before committing."
      exit 1
    fi
  elif [ -f "$PROJECT" ]; then
    echo "[pre-commit] dotnet CLI not found. Install .NET SDK to run compile gate."
    exit 1
  fi
else
  echo "[pre-commit] No staged app files changed under VoiceType/. Skipping app rebuild."
fi

exit 0
